name: Build and publish Go binaries

on:
  release:
    types: [created]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      # 如果上传 release assets，确保有 write 权限（GITHUB_TOKEN 默认足够）
    strategy:
      matrix:
        os: [linux, windows]
        go-version: [1.25.5]    # 根据需要调整
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}

      - name: Build
        env:
          GOOS: ${{ matrix.os == 'windows' && 'windows' || 'linux' }}
          GOARCH: amd64
        run: |
          mkdir -p dist
          if [ "${{ matrix.os }}" = "windows" ]; then
            GOOS=windows GOARCH=amd64 go build -o disk.exe ./...
          else
            GOOS=linux GOARCH=amd64 go build -o disk ./...
          fi

      - name: Upload Release Asset
        # 这里用社区 action 或 GitHub API 上传到当前 release
        # 推荐在 release workflow 中使用可将文件附加到触发 release 的 action
        uses: softprops/action-gh-release@v1
        with:
          files: disk.exe,disk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
